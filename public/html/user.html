<h1>사용자 관리</h1>
<p>
  <h2>사용자 목록</h2>
  <table border=0 cellspacing=0 id="users">
    <thead>
      <tr>
        <td>이메일</td>
        <td>닉네임</td>
        <td>지갑 주소</td>
        <td>현재 토큰</td>
      <tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <button onclick="lookUpUsers()">조회</button>
  <h2>토큰 송금</h2>
  <table border=0 cellspacing=0 id="sendtoken">
    <thead>
      <tr>
        <td>이메일</td>
        <td>보낼 양</td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <button onclick="addRow()">행 추가</button><button onclick="deleteRow()">행 삭제</button>
  <input type="text" class="text" id="pkey" placeholder="Private Key" /><button onclick="sendToken()">토큰 전송</button>
</p>

<script type="text/javascript">
  var row = 0;

  function lookUpUsers() {
    $("#users tbody tr").remove();

    var table = document.getElementById("users").getElementsByTagName('tbody')[0];

    $.post('/token/balance', function(response) {
      response = JSON.parse(response);
      for (i = 0; i < response.length; i++) {
        var newRow = table.insertRow(-1);

        var email = newRow.insertCell(0);
        var nickname = newRow.insertCell(1);
        var w_address = newRow.insertCell(2);
        var amount = newRow.insertCell(3);

        email.innerHTML = response.content[i].email;
        nickname.innerHTML = response.content[i].nickname;
        w_address.innerHTML = response.content[i].w_address;
        amount.innerHTML = response.content[i].amount;
      }
    });
  }

  function sendToken() {
    var table = document.getElementById("sendtoken").getElementsByTagName('tbody')[0];
    var arr = [];

    for (j = 1; j <= row; j++) {
      arr.push([document.getElementById("#email" + j).value, document.getElementById("#amount" + j).value]);
    }

    firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
      $.post("/token/send", {
        token: idToken,
        length: row,
        send: arr
      }, function(response) {
        response = JSON.parse(response);
        while (row > 0) {
          row = row - 1;
          if (!response.includes(row)) {
            table.deleteRow(row);
          }
        }
        if (response.length != 0) {
          alert("실패한 내역이 있습니다.");
          row = response.length;
        }
      });
    });
  }

  function addRow() {
    var table = document.getElementById("sendtoken").getElementsByTagName('tbody')[0];
    var newRow = table.insertRow(row);
    row = row + 1;

    var email = newRow.insertCell(0);
    var amount = newRow.insertCell(1);

    email.innerHTML = "<input id=\"email" + row + "\"type=\"text\" class=\"text\" placeholder=\"이메일\"></input>";
    amount.innerHTML = "<input id=\"amount" + row + "\"type=\"text\" class=\"text\" placeholder=\"보낼 토큰\"></input>";
  }

  function deleteRow() {
    var table = document.getElementById("sendtoken").getElementsByTagName('tbody')[0];
    row = row - 1;
    table.deleteRow(row);
  }

  /*function init() {
    lookUpUsers();
    setInterval("lookUpUsers()", 3600000);
  }*/
</script>
