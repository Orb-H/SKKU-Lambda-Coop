<h1>사용자 관리</h1>
<p>
  <h2>사용자 목록</h2>
  <table border=0 cellspacing=0 id="users">
    <thead>
      <tr>
        <td>이메일</td>
        <td>닉네임</td>
        <td>지갑 주소</td>
        <td>현재 토큰</td>
      <tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <button onclick="lookUpUsers()">조회</button>
  <h2>토큰 송금</h2>
  <table border=0 cellspacing=0 id="sendtoken">
    <thead>
      <tr>
        <td>이메일</td>
        <td>보낼 양</td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <button onclick="addRow()">행 추가</button><button onclick="deleteRow()">행 삭제</button>
  <input type="text" class="text" id="pkey" placeholder="Private Key" /><button onclick="sendToken()">토큰 전송</button>
</p>

<script src="js/config.js"></script>
<script type="text/javascript">
  var row = 0;

  function lookUpUsers() {
    $("#users tbody tr").remove();

    var table = document.getElementById("users").getElementsByTagName('tbody')[0];

    var db = firebase.firestore();
    db.collection('login').get().then(snapshot => {
      snapshot.forEach((doc) => {
        var newRow = table.insertRow(-1);

        var email = newRow.insertCell(0);
        var nickname = newRow.insertCell(1);
        var w_address = newRow.insertCell(2);
        var amount = newRow.insertCell(3);

        var data = doc.data();

        email.innerHTML = data.email;
        nickname.innerHTML = data.nickname;
        w_address.innerHTML = data.w_address;
        if (data.w_address.length !== 0) {
          $.ajax({
            type: 'get',
            url: 'https://api.luniverse.io/tx/v1.0/wallets/' + data.w_address + '/' + config.mt.symbol + '/' + config.st.symbol + '/balance',
            headers: {
              "Authorization": "Bearer " + config.dapp.apiKey,
              "Content-type": "application/json"
            },
            success: function(data) {
              if (data.result) {
                amount.innerHTML = data.data.balance;
              } else {
                amount.innerHTML = "Not Available";
              }
            }
          });
        }
      })
    });
  }

  function sendToken() {
    var table = document.getElementById("sendtoken").getElementsByTagName('tbody')[0];

    var db = firebase.firestore();

    var sub = 0;
    var todo = [];

    for (i = 0; i < row; i++) {
      if (!$("#email" + (i + 1)).hasClass('invalid')) {
        $("#email" + (i + 1)).toggleClass('invalid');
      }
      if (!$("#amount" + (i + 1)).hasClass('invalid')) {
        $("#amount" + (i + 1)).toggleClass('invalid');
      }
      todo.push(i + 1);
    }

    db.collection('login').get().then((snapshot) => {
      snapshot.forEach((doc) => {
        var data = doc.data();
        todo.forEach((index) => {
          if (data.email === document.getElementById("email" + index).value) {
            var sendData = '{"inputs": {"receiverAddress": "' + data.w_address + '", "valueAmount": "' + document.getElementById("amount" + index).value + '"}}';
            sendData = JSON.parse(sendData);
            $.ajax({
              type: 'post',
              url: 'https://api.luniverse.io/tx/v1.0/transactions/adminSend',
              data: JSON.stringify(sendData),
              headers: {
                "Authorization": "Bearer " + config.dapp.apiKey,
                "Content-Type": "application/json"
              },
              success: function(data) {
                todo.splice(todo.indexOf(index), 1);
                if (data.result) {
                  sub = sub + 1;
                  table.deleteRow(index - sub);
                  row = row - 1;
                } else {
                  $("#amount" + j).toggleClass('invalid');
                }
              },
              error: function(data) {
                console.log(data.message);
              }
            });
          }
        });
      });
    });
  }

  function addRow() {
    var table = document.getElementById("sendtoken").getElementsByTagName('tbody')[0];
    var newRow = table.insertRow(row);
    row = row + 1;

    var email = newRow.insertCell(0);
    var amount = newRow.insertCell(1);

    email.innerHTML = "<input id=\"email" + row + "\" type=\"text\" class=\"text\" placeholder=\"이메일\"></input>";
    amount.innerHTML = "<input id=\"amount" + row + "\" type=\"text\" class=\"text\" placeholder=\"보낼 토큰\"></input>";
  }

  function deleteRow() {
    var table = document.getElementById("sendtoken").getElementsByTagName('tbody')[0];
    row = row - 1;
    table.deleteRow(row);
  }
</script>
