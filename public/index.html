<html>

<head>
	<title>SKKoin Adminstrator Login page</title>
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#072a60">
	<meta name="msapplication-TileColor" content="#072a60">
	<meta name="theme-color" content="#ffffff">
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script defer src="/__/firebase/6.2.4/firebase-app.js"></script>

	<!-- TODO: Add SDKs for Firebase products that you want to use
	     https://firebase.google.com/docs/web/setup#reserved-urls -->
	<script defer src="/__/firebase/6.2.4/firebase-auth.js"></script>

	<!-- Initialize Firebase -->
	<script defer src="/__/firebase/init.js"></script>

	<script defer type="text/javascript">
		function signIn() {
			var id = $("#ID").val();
			var pw = $("#PW").val();

			if (id == '') {
				alert('Fill ID');
			} else if (pw == '') {
				alert('Fill PW');
			} else {
				firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
					.then(function() {
						return firebase.auth().signInWithEmailAndPassword(id, pw)
							.then(function(user) {
								firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
									$.post('/login', {
										token: idToken
									}, function(response) {
										if (response === 'true') {
											location.href = "admin.html";
										} else {
											alert("Is this administrator's account??");
											firebase.auth().signOut();
										}
									});
									console.log(idToken);
								});
							})
							.catch(function(error) {
								var errorCode = error.code;
								var errorMsg = error.message;

								if (errorCode === 'auth/user-not-found') {
									alert('No such user.');
								} else if (errorCode === 'auth/wrong-password') {
									alert('Wrong password.');
								} else {
									alert(errorMsg);
								}
								console.log(error);
							});
					}).catch(function(error) {
						var errorCode = error.code;
						var errorMsg = error.message;
						console.log(errorMsg);
						alert('Something went wrong while configuring authentication system');
					});
			}
		}

		function init() {
			$('#already').hide();
			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					$('#already').show();
					$('#login').attr('disabled', true);
					location.href = 'admin.html';
				} else {
					$('#already').hide();
					$('#login').attr('disabled', false);
				}
			});
		}

		$(document).ready(function() {
			init();

			document.getElementById('ID').addEventListener("keyup", function(event) {
				if (event.keyCode === 13) {
					event.preventDefault();
					signIn();
				}
			});
			document.getElementById('PW').addEventListener("keyup", function(event) {
				if (event.keyCode === 13) {
					event.preventDefault();
					signIn();
				}
			})
		});
	</script>

	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
	<form align=center id="form" class="form" method="post">
		<image src="img/skkoin_icon.svg" width=200 />
		<p />
		<h1 style="font-size:50px;">SKKOIN</h1>
		<input type="text" name="ID" id="ID" class="text" placeholder="아이디" />
		<p />
		<input type="password" name="PW" id="PW" class="text" placeholder="비밀번호" />
		<p />
		<input type="button" name="login" id="login" class="button" value="로그인" onclick="signIn()" />
	</form>
	<p id="already" align=center>You will be redirected to the admin page soon.</p>
</body>

</html>
